(function(r,c){typeof exports=="object"&&typeof module!="undefined"?c(exports,require("path-browserify"),require("json5"),require("bridge-common-utils")):typeof define=="function"&&define.amd?define(["exports","path-browserify","json5","bridge-common-utils"],c):(r=typeof globalThis!="undefined"?globalThis:r||self,c(r.MCProjectCore={},r.pathBrowserify,r.json5,r.bridgeCommonUtils))})(this,function(r,c,C,b){"use strict";function A(l){return l&&typeof l=="object"&&"default"in l?l:{default:l}}var F=A(C);const P={behaviorPack:"./BP",resourcePack:"./RP",skinPack:"./SP",worldTemplate:"./WT"};class x{constructor(e){this.basePath=e,this.data={}}async refreshConfig(){this.data=await this.readConfig()}async setup(){await this.refreshConfig()}get(){return this.data}getRelativePackRoot(e){var t,s;return(s=(t=this.data.packs)==null?void 0:t[e])!=null?s:P[e]}getAbsolutePackRoot(e){return this.resolvePackPath(e)}resolvePackPath(e,t){return!t&&!e?this.basePath:!e&&t?c.join(this.basePath,t):!t&&e?c.resolve(this.basePath,this.getRelativePackRoot(e)):c.resolve(this.basePath,`${this.getRelativePackRoot(e)}/${t}`)}getAvailablePackPaths(){var t;const e=[];for(const s of Object.keys((t=this.data.packs)!=null?t:{}))e.push(this.resolvePackPath(s));return e}getAvailablePacks(){var t;const e={};for(const s in(t=this.data.packs)!=null?t:{})e[s]=this.resolvePackPath(s);return e}async save(){await this.writeConfig(this.data)}}class w{constructor(e){this.projectConfig=e,this.packTypes=[],this.extensionPackTypes=new Set}setProjectConfig(e){this.projectConfig=e}get all(){return this.packTypes.concat(...Array.from(this.extensionPackTypes.values()))}getFromId(e){return this.all.find(t=>t.id===e)}get(e){var s,o;const t=(o=(s=this.projectConfig)==null?void 0:s.getAvailablePacks())!=null?o:P;for(const a in t)if(e.startsWith(t[a]))return this.getFromId(a)}getId(e){var t,s;return(s=(t=this.get(e))==null?void 0:t.id)!=null?s:"unknown"}addExtensionPackType(e){return this.extensionPackTypes.add(e),{dispose:()=>this.extensionPackTypes.delete(e)}}}class M{constructor(e,t){this.projectConfig=e,this.isMatch=t,this.pluginFileTypes=new Set,this.fileTypes=[]}get all(){return this.fileTypes.concat([...this.pluginFileTypes.values()])}setProjectConfig(e){this.projectConfig=e}addPluginFileType(e){return this.pluginFileTypes.add(e),{dispose:()=>this.pluginFileTypes.delete(e)}}getPluginFileTypes(){return[...this.pluginFileTypes.values()]}setPluginFileTypes(e=[]){this.pluginFileTypes.clear(),e.forEach(t=>this.pluginFileTypes.add(t))}get(e,t){var o,a,d,g,n,p,h,f,u,y,k,T,j;const s=e?c.extname(e):null;if(!!s)for(const i of this.all){if(t!==void 0&&t===i.id)return i;if(!e)continue;const v=((o=i.detect)==null?void 0:o.packType)===void 0?[]:Array.isArray((a=i.detect)==null?void 0:a.packType)?(d=i.detect)==null?void 0:d.packType:[(g=i.detect)==null?void 0:g.packType],m=(n=i.detect)==null?void 0:n.fileExtensions,R=!!((p=i.detect)==null?void 0:p.scope),S=Array.isArray((h=i.detect)==null?void 0:h.scope)?(f=i.detect)==null?void 0:f.scope:[(u=i.detect)==null?void 0:u.scope],E=!!((y=i.detect)==null?void 0:y.matcher),W=Array.isArray((k=i.detect)==null?void 0:k.matcher)?(T=i.detect)==null?void 0:T.matcher:[(j=i.detect)==null?void 0:j.matcher];if(!(m&&!m.includes(s)))if(R){if(this.prefixMatchers(v,S).some(_=>e.startsWith(_)))return i}else if(E){if(this.isMatch(e,this.prefixMatchers(v,W)))return i}else throw console.log(i),new Error('Invalid file definition, no "detect" properties')}}prefixMatchers(e,t){if(!this.projectConfig)return[];if(e.length===0)return t.map(o=>this.projectConfig.resolvePackPath(void 0,o));const s=[];for(const o of e)for(const a of t)s.push(this.projectConfig.resolvePackPath(o,a));return s}getIds(){const e=[];for(const t of this.all)e.push(t.id);return e}async guessFolder(e){var d,g;const t=(n,p)=>{var u,y;let h=Array.isArray(n)?n[0]:n;h.endsWith("/")||(h+="/");const f=(y=(u=this.projectConfig)==null?void 0:u.getAbsolutePackRoot(p))!=null?y:"./unknown";return c.join(f,h)},s=`.${e.name.split(".").pop()}`;for(const{detect:n={}}of this.all)if(!!n.scope&&((d=n.fileExtensions)==null?void 0:d.includes(s)))return t(n.scope,Array.isArray(n.packType)?n.packType[0]:(g=n.packType)!=null?g:"behaviorPack");if(!e.name.endsWith(".json"))return null;const o=await e.getFile();let a;try{a=F.default.parse(await o.text())}catch{return null}for(const{type:n,detect:p}of this.all){if(typeof n=="string"&&n!=="json")continue;const{scope:h,fileContent:f,packType:u="behaviorPack"}=p!=null?p:{};if(!(!h||!f)&&!!b.hasAnyPath(a,f))return t(h,Array.isArray(u)?u[0]:u)}return null}getId(e){var t,s;return(s=(t=this.get(e))==null?void 0:t.id)!=null?s:"unknown"}isJsonFile(e){var s,o;const t=(o=(s=this.get(e))==null?void 0:s.meta)==null?void 0:o.language;return t?t==="json":e.endsWith(".json")}}r.FileType=M,r.PackType=w,r.ProjectConfig=x,r.defaultPackPaths=P,Object.defineProperty(r,"__esModule",{value:!0}),r[Symbol.toStringTag]="Module"});
