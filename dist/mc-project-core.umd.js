(function(o,c){typeof exports=="object"&&typeof module!="undefined"?c(exports,require("path-browserify"),require("json5"),require("bridge-common-utils")):typeof define=="function"&&define.amd?define(["exports","path-browserify","json5","bridge-common-utils"],c):(o=typeof globalThis!="undefined"?globalThis:o||self,c(o.MCProjectCore={},o.pathBrowserify,o.json5,o.bridgeCommonUtils))})(this,function(o,c,x,M){"use strict";function w(l){return l&&typeof l=="object"&&"default"in l?l:{default:l}}var R=w(x);const j={behaviorPack:"./BP",resourcePack:"./RP",skinPack:"./SP",worldTemplate:"./WT"};class _{constructor(t){this.basePath=t,this.data={}}async refreshConfig(){this.data=await this.readConfig()}async setup(){await this.refreshConfig()}get(){return this.data}getRelativePackRoot(t){var e,s;return(s=(e=this.data.packs)==null?void 0:e[t])!=null?s:j[t]}getAbsolutePackRoot(t){return this.resolvePackPath(t)}resolvePackPath(t,e){return!e&&!t?this.basePath:!t&&e?c.join(this.basePath,e):!e&&t?c.join(this.basePath,this.getRelativePackRoot(t)):c.join(this.basePath,`${this.getRelativePackRoot(t)}/${e}`)}getAvailablePackPaths(){var e;const t=[];for(const s of Object.keys((e=this.data.packs)!=null?e:{}))t.push(this.resolvePackPath(s));return t}getAvailablePacks(){var e;const t={};for(const s in(e=this.data.packs)!=null?e:{})t[s]=this.resolvePackPath(s);return t}async save(){await this.writeConfig(this.data)}}class E{constructor(t){this.projectConfig=t,this.packTypes=[],this.extensionPackTypes=new Set}setProjectConfig(t){this.projectConfig=t}get all(){return this.packTypes.concat(...Array.from(this.extensionPackTypes.values()))}getFromId(t){return this.all.find(e=>e.id===t)}get(t){var s,r;const e=(r=(s=this.projectConfig)==null?void 0:s.getAvailablePacks())!=null?r:j;for(const h in e)if(t.startsWith(e[h]))return this.getFromId(h)}getId(t){var e,s;return(s=(e=this.get(t))==null?void 0:e.id)!=null?s:"unknown"}addExtensionPackType(t){return this.extensionPackTypes.add(t),{dispose:()=>this.extensionPackTypes.delete(t)}}}class S{constructor(t,e){this.projectConfig=t,this.isMatch=e,this.pluginFileTypes=new Set,this._fileTypes=[]}get fileTypes(){return this._fileTypes}set fileTypes(t){this._fileTypes=t.sort((e,s)=>e.add==="post"&&s.add!=="post"?1:e.add!=="post"&&s.add==="post"||e.add==="pre"&&s.add!=="pre"?-1:e.add!=="pre"&&s.add==="pre"?1:0)}get all(){return this.fileTypes.concat([...this.pluginFileTypes.values()])}setProjectConfig(t){this.projectConfig=t}addPluginFileType(t){return this.pluginFileTypes.add(t),{dispose:()=>this.pluginFileTypes.delete(t)}}getPluginFileTypes(){return[...this.pluginFileTypes.values()]}setPluginFileTypes(t=[]){this.pluginFileTypes.clear(),t.forEach(e=>this.pluginFileTypes.add(e))}get(t,e,s=!0){var h,k,T,f,y,i,a,p,d,u,g,A,C;const r=t?c.extname(t):null;if(!!r)for(const n of this.all){if(e!==void 0&&e===n.id)return n;if(!t)continue;const m=((h=n.detect)==null?void 0:h.packType)===void 0?[]:Array.isArray((k=n.detect)==null?void 0:k.packType)?(T=n.detect)==null?void 0:T.packType:[(f=n.detect)==null?void 0:f.packType],b=(y=n.detect)==null?void 0:y.fileExtensions,W=!!((i=n.detect)==null?void 0:i.scope),I=Array.isArray((a=n.detect)==null?void 0:a.scope)?(p=n.detect)==null?void 0:p.scope:[(d=n.detect)==null?void 0:d.scope],q=!!((u=n.detect)==null?void 0:u.matcher),F=Array.isArray((g=n.detect)==null?void 0:g.matcher)?(A=n.detect)==null?void 0:A.matcher:[(C=n.detect)==null?void 0:C.matcher];if(!(s&&b&&!b.includes(r)))if(W){if(this.prefixMatchers(m,I).some(v=>t.startsWith(v)))return n}else if(q){const v=this.prefixMatchers(m,F.filter(P=>!P.startsWith("!"))),O=this.prefixMatchers(m,F.filter(P=>P.startsWith("!")).map(P=>P.slice(1)));if(this.isMatch(t,v)&&!this.isMatch(t,O))return n}else throw console.log(n),new Error('Invalid file definition, no "detect" properties')}}prefixMatchers(t,e){if(!this.projectConfig)return[];if(t.length===0)return e.map(r=>this.projectConfig.resolvePackPath(void 0,r));const s=[];for(const r of t)for(const h of e)s.push(this.projectConfig.resolvePackPath(r,h));return s}getIds(){const t=[];for(const e of this.all)t.push(e.id);return t}async guessFolder(t){var y;const e=(i,a)=>{var u,g;let p=Array.isArray(i)?i[0]:i;p.endsWith("/")||(p+="/");const d=(g=(u=this.projectConfig)==null?void 0:u.getAbsolutePackRoot(a))!=null?g:"./unknown";return c.join(d,p)},s=`.${t.name.split(".").pop()}`,r=this.all.filter(({detect:i})=>{var a;return!i||!i.scope?!1:(a=i.fileExtensions)==null?void 0:a.includes(s)}),h=r.length===1,k=s!==".json"&&r.length>0;if(h||k){const{detect:i}=r[0];return e(i.scope,Array.isArray(i.packType)?i.packType[0]:(y=i.packType)!=null?y:"behaviorPack")}if(s!==".json")return null;const T=await t.getFile();let f;try{f=R.default.parse(await T.text())}catch{return null}for(const{type:i,detect:a}of r){if(typeof i=="string"&&i!=="json")continue;const{scope:p,fileContent:d,packType:u="behaviorPack"}=a!=null?a:{};if(!(!p||!d)&&!!M.hasAnyPath(f,d))return e(p,Array.isArray(u)?u[0]:u)}return null}getId(t){var e,s;return(s=(e=this.get(t))==null?void 0:e.id)!=null?s:"unknown"}isJsonFile(t){var s,r;const e=(r=(s=this.get(t))==null?void 0:s.meta)==null?void 0:r.language;return e?e==="json":t.endsWith(".json")}}o.FileType=S,o.PackType=E,o.ProjectConfig=_,o.defaultPackPaths=j,Object.defineProperty(o,"__esModule",{value:!0}),o[Symbol.toStringTag]="Module"});
