(function(o,c){typeof exports=="object"&&typeof module!="undefined"?c(exports,require("path-browserify"),require("json5"),require("bridge-common-utils")):typeof define=="function"&&define.amd?define(["exports","path-browserify","json5","bridge-common-utils"],c):(o=typeof globalThis!="undefined"?globalThis:o||self,c(o.MCProjectCore={},o.pathBrowserify,o.json5,o.bridgeCommonUtils))})(this,function(o,c,x,w){"use strict";function M(l){return l&&typeof l=="object"&&"default"in l?l:{default:l}}var R=M(x);const k={behaviorPack:"./BP",resourcePack:"./RP",skinPack:"./SP",worldTemplate:"./WT"};class W{constructor(t){this.basePath=t,this.data={}}async refreshConfig(){this.data=await this.readConfig()}async setup(){await this.refreshConfig()}get(){return this.data}getRelativePackRoot(t){var e,s;return(s=(e=this.data.packs)==null?void 0:e[t])!=null?s:k[t]}getAbsolutePackRoot(t){return this.resolvePackPath(t)}resolvePackPath(t,e){return!e&&!t?this.basePath:!t&&e?c.join(this.basePath,e):!e&&t?c.join(this.basePath,this.getRelativePackRoot(t)):c.join(this.basePath,`${this.getRelativePackRoot(t)}/${e}`)}getAvailablePackPaths(){var e;const t=[];for(const s of Object.keys((e=this.data.packs)!=null?e:{}))t.push(this.resolvePackPath(s));return t}getAvailablePacks(){var e;const t={};for(const s in(e=this.data.packs)!=null?e:{})t[s]=this.resolvePackPath(s);return t}async save(){await this.writeConfig(this.data)}}class S{constructor(t){this.projectConfig=t,this.packTypes=[],this.extensionPackTypes=new Set}setProjectConfig(t){this.projectConfig=t}get all(){return this.packTypes.concat(...Array.from(this.extensionPackTypes.values()))}getFromId(t){return this.all.find(e=>e.id===t)}get(t){var s,r;const e=(r=(s=this.projectConfig)==null?void 0:s.getAvailablePacks())!=null?r:k;for(const a in e)if(t.startsWith(e[a]))return this.getFromId(a)}getId(t){var e,s;return(s=(e=this.get(t))==null?void 0:e.id)!=null?s:"unknown"}addExtensionPackType(t){return this.extensionPackTypes.add(t),{dispose:()=>this.extensionPackTypes.delete(t)}}}class E{constructor(t,e){this.projectConfig=t,this.isMatch=e,this.pluginFileTypes=new Set,this.fileTypes=[]}get all(){return this.fileTypes.concat([...this.pluginFileTypes.values()])}setProjectConfig(t){this.projectConfig=t}addPluginFileType(t){return this.pluginFileTypes.add(t),{dispose:()=>this.pluginFileTypes.delete(t)}}getPluginFileTypes(){return[...this.pluginFileTypes.values()]}setPluginFileTypes(t=[]){this.pluginFileTypes.clear(),t.forEach(e=>this.pluginFileTypes.add(e))}get(t,e,s=!0){var a,d,g,n,p,h,f,u,y,m,v,C,b;const r=t?c.extname(t):null;if(!!r)for(const i of this.all){if(e!==void 0&&e===i.id)return i;if(!t)continue;const T=((a=i.detect)==null?void 0:a.packType)===void 0?[]:Array.isArray((d=i.detect)==null?void 0:d.packType)?(g=i.detect)==null?void 0:g.packType:[(n=i.detect)==null?void 0:n.packType],A=(p=i.detect)==null?void 0:p.fileExtensions,_=!!((h=i.detect)==null?void 0:h.scope),I=Array.isArray((f=i.detect)==null?void 0:f.scope)?(u=i.detect)==null?void 0:u.scope:[(y=i.detect)==null?void 0:y.scope],q=!!((m=i.detect)==null?void 0:m.matcher),F=Array.isArray((v=i.detect)==null?void 0:v.matcher)?(C=i.detect)==null?void 0:C.matcher:[(b=i.detect)==null?void 0:b.matcher];if(!(s&&A&&!A.includes(r)))if(_){if(this.prefixMatchers(T,I).some(j=>t.startsWith(j)))return i}else if(q){const j=this.prefixMatchers(T,F.filter(P=>!P.startsWith("!"))),$=this.prefixMatchers(T,F.filter(P=>P.startsWith("!")).map(P=>P.slice(1)));if(this.isMatch(t,j)&&!this.isMatch(t,$))return i}else throw console.log(i),new Error('Invalid file definition, no "detect" properties')}}prefixMatchers(t,e){if(!this.projectConfig)return[];if(t.length===0)return e.map(r=>this.projectConfig.resolvePackPath(void 0,r));const s=[];for(const r of t)for(const a of e)s.push(this.projectConfig.resolvePackPath(r,a));return s}getIds(){const t=[];for(const e of this.all)t.push(e.id);return t}async guessFolder(t){var d,g;const e=(n,p)=>{var u,y;let h=Array.isArray(n)?n[0]:n;h.endsWith("/")||(h+="/");const f=(y=(u=this.projectConfig)==null?void 0:u.getAbsolutePackRoot(p))!=null?y:"./unknown";return c.join(f,h)},s=`.${t.name.split(".").pop()}`;for(const{detect:n={}}of this.all)if(!!n.scope&&((d=n.fileExtensions)==null?void 0:d.includes(s)))return e(n.scope,Array.isArray(n.packType)?n.packType[0]:(g=n.packType)!=null?g:"behaviorPack");if(!t.name.endsWith(".json"))return null;const r=await t.getFile();let a;try{a=R.default.parse(await r.text())}catch{return null}for(const{type:n,detect:p}of this.all){if(typeof n=="string"&&n!=="json")continue;const{scope:h,fileContent:f,packType:u="behaviorPack"}=p!=null?p:{};if(!(!h||!f)&&!!w.hasAnyPath(a,f))return e(h,Array.isArray(u)?u[0]:u)}return null}getId(t){var e,s;return(s=(e=this.get(t))==null?void 0:e.id)!=null?s:"unknown"}isJsonFile(t){var s,r;const e=(r=(s=this.get(t))==null?void 0:s.meta)==null?void 0:r.language;return e?e==="json":t.endsWith(".json")}}o.FileType=E,o.PackType=S,o.ProjectConfig=W,o.defaultPackPaths=k,Object.defineProperty(o,"__esModule",{value:!0}),o[Symbol.toStringTag]="Module"});
