(function(a,c){typeof exports=="object"&&typeof module!="undefined"?c(exports,require("pathe"),require("json5"),require("@bridge-editor/common-utils")):typeof define=="function"&&define.amd?define(["exports","pathe","json5","@bridge-editor/common-utils"],c):(a=typeof globalThis!="undefined"?globalThis:a||self,c(a.MCProjectCore={},a.pathe,a.json5,a.commonUtils))})(this,function(a,c,b,M){"use strict";function w(p){return p&&typeof p=="object"&&"default"in p?p:{default:p}}var R=w(b);const m={behaviorPack:"./BP",resourcePack:"./RP",skinPack:"./SP",worldTemplate:"./WT"};class E{constructor(t){this.basePath=t,this.data={}}async refreshConfig(){this.data=await this.readConfig()}async setup(){await this.refreshConfig()}get(){return this.data}getRelativePackRoot(t){var e,s;return(s=(e=this.data.packs)==null?void 0:e[t])!=null?s:m[t]}getAbsolutePackRoot(t){return this.resolvePackPath(t)}resolvePackPath(t,e){return!e&&!t?this.basePath:!t&&e?c.join(this.basePath,e):!e&&t?c.join(this.basePath,this.getRelativePackRoot(t)):c.join(this.basePath,this.getRelativePackRoot(t),e!=null?e:"")}getAvailablePackPaths(){var e;const t=[];for(const s of Object.keys((e=this.data.packs)!=null?e:{}))t.push(this.resolvePackPath(s));return t}getAvailablePacks(){var e;const t={};for(const s in(e=this.data.packs)!=null?e:{})t[s]=this.resolvePackPath(s);return t}async save(){await this.writeConfig(this.data)}}class _{constructor(t){this.projectConfig=t,this.packTypes=[],this.extensionPackTypes=new Set}setProjectConfig(t){this.projectConfig=t}get all(){return this.packTypes.concat(...Array.from(this.extensionPackTypes.values()))}getFromId(t){return this.all.find(e=>e.id===t)}get(t,e=!1){var r;let s=(r=this.projectConfig)==null?void 0:r.getAvailablePacks();(!s||e)&&(s=Object.fromEntries(Object.keys(m).map(o=>{var f;const h=(f=this.projectConfig)==null?void 0:f.resolvePackPath(o);return h?[o,h]:null}).filter(o=>o!==null)));for(const o in s)if(t.startsWith(s[o]))return this.getFromId(o)}getId(t){var e,s;return(s=(e=this.get(t))==null?void 0:e.id)!=null?s:"unknown"}addExtensionPackType(t){return this.extensionPackTypes.add(t),{dispose:()=>this.extensionPackTypes.delete(t)}}}class S{constructor(t,e){this.projectConfig=t,this.isMatch=e,this.pluginFileTypes=new Set,this._fileTypes=[]}get fileTypes(){return this._fileTypes}set fileTypes(t){this._fileTypes=t.sort((e,s)=>e.add==="post"&&s.add!=="post"?1:e.add!=="post"&&s.add==="post"||e.add==="pre"&&s.add!=="pre"?-1:e.add!=="pre"&&s.add==="pre"?1:0)}get all(){return this.fileTypes.concat([...this.pluginFileTypes.values()])}setProjectConfig(t){this.projectConfig=t}addPluginFileType(t){return this.pluginFileTypes.add(t),{dispose:()=>this.pluginFileTypes.delete(t)}}getPluginFileTypes(){return[...this.pluginFileTypes.values()]}setPluginFileTypes(t=[]){this.pluginFileTypes.clear(),t.forEach(e=>this.pluginFileTypes.add(e))}get(t,e,s=!0){var o,h,f,g,k,i,l,d,y,u,P,T,C;const r=t?c.extname(t):null;if(!!r)for(const n of this.all){if(e!==void 0&&e===n.id)return n;if(!t)continue;const v=((o=n.detect)==null?void 0:o.packType)===void 0?[]:Array.isArray((h=n.detect)==null?void 0:h.packType)?(f=n.detect)==null?void 0:f.packType:[(g=n.detect)==null?void 0:g.packType],x=(k=n.detect)==null?void 0:k.fileExtensions,W=!!((i=n.detect)!=null&&i.scope),O=Array.isArray((l=n.detect)==null?void 0:l.scope)?(d=n.detect)==null?void 0:d.scope:[(y=n.detect)==null?void 0:y.scope],q=!!((u=n.detect)!=null&&u.matcher),F=Array.isArray((P=n.detect)==null?void 0:P.matcher)?(T=n.detect)==null?void 0:T.matcher:[(C=n.detect)==null?void 0:C.matcher];if(!(s&&x&&!x.includes(r)))if(W){if(this.prefixMatchers(v,O).some(A=>t.startsWith(A)))return n}else if(q){const A=this.prefixMatchers(v,F.filter(j=>!j.startsWith("!"))),I=this.prefixMatchers(v,F.filter(j=>j.startsWith("!")).map(j=>j.slice(1)));if(this.isMatch(t,A)&&!this.isMatch(t,I))return n}else throw console.log(n),new Error('Invalid file definition, no "detect" properties')}}prefixMatchers(t,e){if(!this.projectConfig)return[];if(t.length===0)return e.map(r=>this.projectConfig.resolvePackPath(void 0,r));const s=[];for(const r of t)for(const o of e)s.push(this.projectConfig.resolvePackPath(r,o));return s}getIds(){const t=[];for(const e of this.all)t.push(e.id);return t}async guessFolder(t){var k;const e=(i,l)=>{var P,T;let d=Array.isArray(i)?i[0]:i;const y=(T=(P=this.projectConfig)==null?void 0:P.getAbsolutePackRoot(l))!=null?T:"./unknown";let u=c.join(y,d);return u.endsWith(c.sep)||(u+=c.sep),u},s=`.${t.name.split(".").pop()}`,r=this.all.filter(({detect:i})=>{var l;return!i||!i.scope?!1:(l=i.fileExtensions)==null?void 0:l.includes(s)}),o=r.length===1,h=s!==".json"&&r.length>0;if(o||h){const{detect:i}=r[0];return e(i.scope,Array.isArray(i.packType)?i.packType[0]:(k=i.packType)!=null?k:"behaviorPack")}if(s!==".json")return null;const f=await t.getFile();let g;try{g=R.default.parse(await f.text())}catch{return null}for(const{type:i,detect:l}of r){if(typeof i=="string"&&i!=="json")continue;const{scope:d,fileContent:y,packType:u="behaviorPack"}=l!=null?l:{};if(!(!d||!y)&&!!M.hasAnyPath(g,y))return e(d,Array.isArray(u)?u[0]:u)}return null}getId(t){var e,s;return(s=(e=this.get(t))==null?void 0:e.id)!=null?s:"unknown"}isJsonFile(t){var s,r;const e=(r=(s=this.get(t))==null?void 0:s.meta)==null?void 0:r.language;return e?e==="json":t.endsWith(".json")}}a.FileType=S,a.PackType=_,a.ProjectConfig=E,a.defaultPackPaths=m,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
